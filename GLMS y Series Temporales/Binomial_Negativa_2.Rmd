---
title: "R Notebook"
output: html_notebook
---

#Otro ejemplo de binomial negativa.
Negative binomial regression is for modeling count variables, usually for over-dispersed count outcome variables.

Lo he sacado de:
https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/

```{r}
library(foreign)
library(ggplot2)
library(MASS)
```

Examples of negative binomial regression
Example 1. School administrators study the attendance behavior of high school juniors at two schools (asistencia de escolares al cole). Predictors of the number of days of absence (ausencia) include the type of program in which the student is enrolled and a standardized test in math. (Tipo de programa al que está matriculado el estudiante y un examen estándarizado de mates).

Example 2. A health-related researcher is studying the number of hospital visits in past 12 months by senior citizens (personas mayores) in a community based on the characteristics of the individuals (caracteristicas de los viejitos) and the types of health plans under which each one is covered (tipos de planes de salud).

Empezamos con el Ejemplo 1:

We have attendance data on 314 high school juniors from two urban high schools in the file nb_data. The response variable of interest is days absent, daysabs. The variable math gives the standardized math score for each student. The variable prog is a three-level nominal variable indicating the type of instructional program in which the student is enrolled.

Let’s look at the data. It is always a good idea to start with descriptive statistics and plots.
```{r}
dat <- read.dta("https://stats.idre.ucla.edu/stat/stata/dae/nb_data.dta")
dat <- within(dat, {
    prog <- factor(prog, levels = 1:3, labels = c("General", "Academic", "Vocational"))
    id <- factor(id)
})

summary(dat)
```

```{r}
str(dat)
```

```{r}
ggplot(dat, aes(daysabs, fill = prog)) + geom_histogram(binwidth = 1) + facet_grid(prog ~ ., margins = TRUE, scales = "free")
```


Cada variable tiene 314 observaciones válidas y sus distribuciones parecen bastante razonables. La media incondicional de nuestra variable de resultado es mucho más baja que su varianza.

```{r}
mean(dat$daysabs)
sd(dat$daysabs)
var(dat$daysabs)
```

Let’s continue with our description of the variables in this dataset. The table below shows the average numbers of days absent by program type and seems to suggest that program type is a good candidate for predicting the number of days absent, our outcome variable, because the mean value of the outcome appears to vary by prog. The variances within each level of prog are higher than the means within each level. These are the conditional means and variances. These differences suggest that over-dispersion is present and that a Negative Binomial model would be appropriate.

```{r}
with(dat, tapply(daysabs, prog, function(x) {
    sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
}))
```

IMPORTANTE:
Las variaciones dentro de cada nivel de progreso son mayores que las medias dentro de cada nivel. Estos son los medios y variaciones condicionales. Estas diferencias sugieren que la dispersión excesiva está presente y que un modelo binomial negativo sería apropiado.


METODOS DE ANÁLISIS QUE PODRÍAMOS CONSIDERAR:
A continuación hay una lista de algunos métodos de análisis que puede haber encontrado. Algunos de los métodos enumerados son bastante razonables, mientras que otros han caído en desgracia o tienen limitaciones.

  Negative binomial regression -Negative binomial regression can be used for over-dispersed count data, that is when the conditional   variance exceeds the conditional mean. It can be considered as a generalization of Poisson regression since it has the same mean structure as Poisson regression and it has an extra parameter to model the over-dispersion. If the conditional distribution of the outcome variable is over-dispersed, the confidence intervals for the Negative binomial regression are likely to be narrower (mas estrechos) as compared to those from a Poisson regression model.
  
  Poisson regression – Poisson regression is often used for modeling count data. Poisson regression has a number of extensions useful for count models. Pero sin over-dispersion.
  
  Zero-inflated regression model – Zero-inflated models attempt to account for excess zeros (intenta dar cuenta del exceso de ceros). In other words, two kinds of zeros are thought to exist in the data, “true zeros” and “excess zeros”. Zero-inflated models estimate two equations simultaneously, one for the count model and one for the excess zeros. 
  
  OLS regression – Count outcome variables are sometimes log-transformed and analyzed using OLS regression. Many issues arise with this approach, including loss of data due to undefined values generated by taking the log of zero (which is undefined), as well as the lack of capacity to model the dispersion.

#####################################
Negative binomial regression analysis
```{r}
m1 <- glm.nb(daysabs ~ math + prog, data = dat)

summary(m1)
```

```{r}
m1 <- glm.nb(daysabs ~ math + prog, data = dat)
summary(m1)
```

R first displays the call and the deviance residuals. Next, we see the regression coefficients for each of the variables, along with standard errors, z-scores, and p-values. The variable math has a coefficient of -0.006, which is statistically significant. This means that for each one-unit increase in math, the expected log count of the number of days absent decreases by 0.006. The indicator variable shown as progAcademic is the expected difference in log count between group 2 and the reference group (prog=1). The expected log count for level 2 of prog is 0.44 lower than the expected log count for level 1. The indicator variable for progVocational is the expected difference in log count between group 3 and the reference group.The expected log count for level 3 of prog is 1.28 lower than the expected log count for level 1. To determine if prog itself, overall, is statistically significant, we can compare a model with and without prog. The reason it is important to fit separate models, is that unless we do, the overdispersion parameter is held constant.

```{r}
m2 <- update(m1, . ~ . - prog)
anova(m1, m2)
```


La prueba de chicuadrado de dos grados de libertad indica que el prog es un predictor estadísticamente significativo de daysabs
